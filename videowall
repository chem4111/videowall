#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICE_NAME="videowall"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

show_help() {
    echo "视频墙管理工具"
    echo ""
    echo "用法: videowall <命令>"
    echo ""
    echo "命令:"
    echo "  start    启动视频墙应用（前台运行）"
    echo "  init     初始化视频封面（为所有视频生成封面图）"
    echo "  enable   创建并启用 systemd 服务（开机自启）"
    echo "  disable  禁用并删除 systemd 服务"
    echo "  stop     停止正在运行的视频墙服务"
    echo "  status   查看视频墙服务状态"
    echo "  help     显示此帮助信息"
    echo ""
    echo "示例:"
    echo "  videowall start    # 前台启动应用"
    echo "  videowall init     # 生成视频封面"
    echo "  videowall enable   # 设置开机自启"
    echo "  videowall status   # 查看服务状态"
}

cmd_start() {
    echo "正在启动视频墙应用..."
    cd "$SCRIPT_DIR"
    
    if command -v python3 &> /dev/null; then
        python3 app.py
    elif command -v python &> /dev/null; then
        python app.py
    elif command -v py &> /dev/null; then
        py app.py
    else
        echo "错误: 未找到 Python 解释器"
        exit 1
    fi
}

cmd_enable() {
    echo "正在创建 systemd 服务..."
    
    if [ "$EUID" -ne 0 ]; then
        echo "错误: 此命令需要 sudo 权限"
        echo "请使用: sudo videowall enable"
        exit 1
    fi
    
    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Video Wall Service
After=network.target

[Service]
Type=simple
WorkingDirectory=$SCRIPT_DIR
ExecStart=$(which python3) $SCRIPT_DIR/app.py
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
    
    echo "服务文件已创建: $SERVICE_FILE"
    
    systemctl daemon-reload
    systemctl enable "$SERVICE_NAME"
    systemctl start "$SERVICE_NAME"
    
    echo "✅ 视频墙服务已启用并启动"
    echo "使用 'videowall status' 查看服务状态"
}

cmd_disable() {
    echo "正在禁用视频墙服务..."
    
    if [ "$EUID" -ne 0 ]; then
        echo "错误: 此命令需要 sudo 权限"
        echo "请使用: sudo videowall disable"
        exit 1
    fi
    
    if [ ! -f "$SERVICE_FILE" ]; then
        echo "服务文件不存在，无需删除"
        exit 0
    fi
    
    systemctl stop "$SERVICE_NAME" 2>/dev/null
    systemctl disable "$SERVICE_NAME" 2>/dev/null
    rm -f "$SERVICE_FILE"
    systemctl daemon-reload
    
    echo "✅ 视频墙服务已禁用并删除"
}

cmd_stop() {
    echo "正在停止视频墙服务..."
    
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        if [ "$EUID" -ne 0 ]; then
            echo "错误: 此命令需要 sudo 权限"
            echo "请使用: sudo videowall stop"
            exit 1
        fi
        systemctl stop "$SERVICE_NAME"
        echo "✅ 视频墙服务已停止"
    else
        echo "视频墙服务未运行"
    fi
}

cmd_status() {
    echo "视频墙服务状态:"
    echo ""
    
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        echo "状态: 运行中 ✅"
        systemctl status "$SERVICE_NAME" --no-pager -l
    elif systemctl is-enabled --quiet "$SERVICE_NAME"; then
        echo "状态: 已启用但未运行 ⏸️"
        echo "使用 'sudo videowall start' 启动服务"
    else
        echo "状态: 未启用 ❌"
        echo "使用 'sudo videowall enable' 启用服务"
    fi
}

cmd_init() {
    echo "正在初始化视频封面..."
    cd "$SCRIPT_DIR"
    
    if [ ! -f "gen_covers.py" ]; then
        echo "错误: 未找到 gen_covers.py 文件"
        exit 1
    fi
    
    if ! command -v ffmpeg &> /dev/null; then
        echo "错误: 未找到 ffmpeg，请先安装"
        exit 1
    fi
    
    if command -v python3 &> /dev/null; then
        python3 gen_covers.py
    elif command -v python &> /dev/null; then
        python gen_covers.py
    elif command -v py &> /dev/null; then
        py gen_covers.py
    else
        echo "错误: 未找到 Python 解释器"
        exit 1
    fi
    
    echo "✅ 视频封面初始化完成"
}

case "${1:-help}" in
    start)
        cmd_start
        ;;
    init)
        cmd_init
        ;;
    enable)
        cmd_enable
        ;;
    disable)
        cmd_disable
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "错误: 未知命令 '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac
